# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## What This Is

The Orchestrator is a Python-based autonomous agent delegation framework. It initializes target projects, generates AGENTS.md using Claude, and coordinates specialist agents to implement multi-phase features. The orchestrator itself never writes code—it only routes work to specialist agents.

## Commands

```bash
# Initialize project (uses Claude to generate AGENTS.md)
./run.sh init /path/to/project

# Run orchestration (requires init first)
./run.sh /path/to/project
./run.sh /path/to/project -n 5         # Limit to 5 iterations

# Start fresh session (archives existing session)
./run.sh new /path/to/project

# Check session status
./run.sh status /path/to/project

# Docker variants (same commands)
./docker-run.sh init /path/to/project
./docker-run.sh /path/to/project
./docker-run.sh new /path/to/project
./docker-run.sh status /path/to/project
```

## Workflow

```
1. INIT (one-time setup)
   ./run.sh init /path/to/project
   │
   ├─► Creates .claude/agents/ and .claude/tasks/
   ├─► Discovers existing agent files (*.md)
   └─► Uses Claude to generate intelligent AGENTS.md
       (analyzes agent files, extracts ownership, creates routing table)

2. RUN (orchestration)
   ./run.sh /path/to/project
   │
   ├─► Validates AGENTS.md exists and is valid
   ├─► If no session → Planning mode (asks what to build)
   │   └─► session-planner creates session-current.md
   └─► Execution loop (spawns agents per phase)
```

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│  main.py                                                        │
│    • init_command() - Uses Claude to generate AGENTS.md         │
│    • run_orchestration() - Main execution loop                  │
│    • Tracks timing, tokens, progress                            │
└───────────────────────────┬─────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        ▼                   ▼                   ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────────────┐
│  audit.py     │   │  client.py    │   │  mcp_server/session   │
│  - Discovers  │   │  - SDK config │   │  - Session MCP tools  │
│    agents     │   │  - Simple &   │   │  - Phase management   │
│  - Validates  │   │    full modes │   │  - Work log updates   │
│    AGENTS.md  │   └───────────────┘   └───────────────────────┘
└───────────────┘
```

## Core Framework (in .claude/)

The orchestrator owns core agents and skills:

**Agents** (`.claude/agents/`):
- `session-planner.md` - Plans multi-phase features, creates session files
- `finalize.md` - Validates build, runs tests, proposes commits

**Skills** (`.claude/skills/`):
- `session-management/` - Multi-phase coordination patterns
- `orchestrate-feature/` - Feature routing workflow
- `sub-agent-invocation/` - Agent delegation patterns
- `git-commits/` - Commit orchestration (requires human approval)

## Target Project Setup

Target projects need agent definition files. The `init` command does the rest:

```
target-project/
├── .claude/
│   ├── agents/
│   │   ├── AGENTS.md          # Generated by init command
│   │   ├── your-agent.md      # Your domain agents
│   │   └── another-agent.md
│   └── tasks/
│       └── session-current.md # Created during planning
```

**Agent file format** (`.claude/agents/*.md`):
```markdown
---
name: agent-name
description: What this agent does
---

You are the [Name] Agent...

## Files I OWN:
- src/path/to/files/

## Files I NEVER touch:
- other/paths/
```

## Session File Format

Sessions track multi-phase work in `.claude/tasks/session-current.md`:

```markdown
# Session: feature-name

## Status
- Phase: 1 of 3
- Current Agent: agent-name
- State: pending

## Phases
1. [ ] agent-name - Phase description
2. [ ] other-agent - Another phase
3. [ ] finalize - Validate and commit

## Work Log
(agents update this with implementation notes)
```

## Key Concepts

**The Orchestrator is a ROUTER**: It reads AGENTS.md, spawns sub-agents via the Task tool, and uses session MCP tools to track progress. It never implements code directly.

**Init uses Claude**: Unlike simple template generation, the `init` command uses Claude to analyze your agent files and generate an intelligent AGENTS.md with accurate routing tables and ownership matrices.

**Two-step workflow**: Always run `init` first to generate AGENTS.md, then `run` to start orchestration.

## Environment

- Python 3.11+
- Dependencies: `claude-agent-sdk`, `mcp`, `pydantic`
- Authentication: Auto-detects from `~/.claude` (use `claude login`)
- Default model: `claude-opus-4-5-20251101` (override with `-m` or `CLAUDE_MODEL`)
